#!/bin/bash
set -eu

MATRIXOS_DEV_DIR=$(realpath $(dirname "${0}")/../)

source "${MATRIXOS_DEV_DIR}/headers/env.include.sh"

source "${MATRIXOS_DEV_DIR}/lib/ostree_lib.sh"


# --- Constants & Colors ---
readonly C_RESET='\e[0m'
readonly C_RED='\e[31m'
readonly C_GREEN='\e[32m'
readonly C_YELLOW='\e[33m'
readonly C_BOLD='\e[1m'

get_current_state() {
    local sysroot="${ROOT:-/}"
    # Extract the current booted SHA from ostree admin status
    # We strip the trailing .0 or .1 index from the output
    local old_sha
    old_sha=$(ostree_lib.booted_hash "${sysroot}")

    # Extract the tracking refspec
    local ref
    ref=$(ostree_lib.booted_ref "${sysroot}")

    # Return values via echo for capture, or export strictly if preferred.
    # Here we print them separated by space for easy read.
    echo "${old_sha} ${ref}"
}

fetch_updates() {
    echo -e "${C_BOLD}Fetching updates...${C_RESET}"
    ostree_lib.upgrade "${ROOT:-/}" --pull-only >/dev/null
}

analyze_diff() {
    local old_sha="$1"
    local new_sha="$2"

    echo -e "${C_BOLD}Analyzing package changes...${C_RESET}"

    local old_list
    old_list=$(mktemp)
    local new_list
    new_list=$(mktemp)

    # Capture package states
    ostree_lib.list_packages "${old_sha}" "${ROOT:-/}" > "${old_list}"
    ostree_lib.list_packages "${new_sha}" "${ROOT:-/}" > "${new_list}"

    # Calculate sets
    local removed
    removed=$(comm -23 "${old_list}" "${new_list}")
    local added
    added=$(comm -13 "${old_list}" "${new_list}")

    # Cleanup temp files immediately
    rm "${old_list}" "${new_list}"

    if [[ -z "${removed}" ]] && [[ -z "${added}" ]]; then
        echo "No package changes detected (Config/Binary only update)."
        return 0
    fi

    echo -e "${C_BOLD}Package Changes:${C_RESET}"

    # Process removals and detect upgrades
    for pkg in ${removed}; do
        # Heuristic: Strip version to find package basename (e.g. sys-kernel/linux-6.1 -> sys-kernel/linux)
        local base_name
        base_name=$(qatom -C "${pkg}" --format="%{CATEGORY}/%{PN}")

        # Look for this basename in the 'added' list
        local new_ver
        new_ver=$(echo "${added}" | grep "^${base_name}" || true)

        if [[ -n "${new_ver}" ]]; then
            # Found matching base -> It is an Upgrade
            echo -e "  ✔ ${C_YELLOW}${pkg}${C_RESET} -> ${C_GREEN}${new_ver}${C_RESET}"
            
            # Remove this package from the 'added' list so it isn't listed as "New" later
            added=$(echo "${added}" | grep -v "^${base_name}" || true)
        else
            # No match -> It is a Removal
            echo -e "  ❌ ${C_RED}${pkg}${C_RESET} (Removed)"
        fi
    done

    # Anything remaining in 'added' is a truly new package
    for pkg in ${added}; do
        echo -e "  ✨ ${C_GREEN}${pkg}${C_RESET} (New)"
    done

    echo "---------------------------------------------------"
}

prompt_and_deploy() {
    read -p "Do you want to apply this upgrade? [y/N] " -n 1 -r
    echo
    if [[ "${REPLY}" =~ ^[Yy]$ ]]; then
        echo -e "${C_BOLD}Deploying update...${C_RESET}"
        ostree_lib.upgrade "${ROOT:-/}" --deploy-only
        echo "Please reboot at your earliest convenience."
    else
        echo "Aborted."
        exit 0
    fi
}

main() {
    local state
    state=$(get_current_state)
    local old_sha
    old_sha=$(echo "${state}" | awk '{print $1}')
    local ref
    ref=$(echo "${state}" | awk '{print $2}')

    echo "Creating diff for ref: ${ref}"
    echo "Current Booted SHA:  ${old_sha}"

    fetch_updates
    local new_sha
    new_sha=$(ostree_lib.last_commit_with_sysroot "${ROOT:-/}" "${ref}")

    if [[ "${old_sha}" == "${new_sha}" ]]; then
        echo -e "✅ System is already up to date."
        exit 0
    fi

    echo "Available Update SHA: ${new_sha}"
    echo "---------------------------------------------------"

    analyze_diff "${old_sha}" "${new_sha}"

    prompt_and_deploy
}

# Start
main "$@"