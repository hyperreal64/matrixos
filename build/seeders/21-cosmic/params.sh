#!/bin/bash
# Seeder params, used to inform the seeder orchestration about artifacts
# generated by each seeder. This file is sourced from both outside and
# inside chroot.
set -eu

source "${MATRIXOS_DEV_DIR:-/matrixos}"/headers/env.include.sh
source "${MATRIXOS_DEV_DIR}"/build/seeders/headers/seedersenv.include.sh

# SEEDER_CHROOT_NAME=abc
# Name of the chroot directory that should be created by default.
# First date of the first Monday of the current week, in the past.
SEEDER_CHROOT_NAME="cosmic-$(seeders_env.get_chroot_date)"
if [ "${SEEDER_CHROOT_NAME}" = "cosmic-" ]; then
    echo "Unable to correctly set SEEDER_CHROOT_NAME in cosmic params.sh" >&2
    exit 1
fi

# SEEDER_CHROOTS_DIR=/path/to/parent/seeder/chroots/dir
# Path to the preferred chroot directory for this seeder.
SEEDER_CHROOTS_DIR="${MATRIXOS_DEV_DIR}/out/seeder/chroots"

# PREFERRED_SEEDER_CHROOT_DIR
# Path to the currently preferred chroot directory path for this seeder.
# This way you can implement a dated seeder chroot path via SEEDER_CHROOT_NAME.
PREFERRED_SEEDER_CHROOT_DIR="${SEEDER_CHROOTS_DIR}/${SEEDER_CHROOT_NAME}"

# This function can be used by other seeders to get the chroot path of the latest
# COSMIC build.
cosmic_params.find_latest_chroot_dir() {
    local seeder_name="${1}"
    if [ -z "${seeder_name}" ]; then
        echo "Missing parameter to find_latest_chroot_dir" >&2
        return 1
    fi

    (
        # avoid poisoning our env.
        source "${MATRIXOS_DEV_DIR}"/build/seeders/00-bedrock/params.sh
        bedrock_params.find_latest_chroot_dir_for_derived_seeder "${seeder_name}" "cosmic"
    )
}

# This function can be used by other seeders to get the chroot path of ALL the
# COSMIC builds.
cosmic_params.find_all_chroot_dirs() {
    local seeder_name="${1}"
    (
        # avoid poisoning our env.
        source "${MATRIXOS_DEV_DIR}"/build/seeders/00-bedrock/params.sh
        bedrock_params._find_select_chroot_dirs_for_derived_seeder "${seeder_name}" "cosmic" "1"
    )
}